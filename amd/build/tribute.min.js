function _typeof(e){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(e){return typeof e}}else{_typeof=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e}}return _typeof(e)}(function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define ("format_timeline/tribute",t):(e=e||self,e.Tribute=t())})(this,function(){'use strict';function e(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function t(e,t){for(var n=0,r;n<t.length;n++){r=t[n];r.enumerable=r.enumerable||!1;r.configurable=!0;if("value"in r)r.writable=!0;Object.defineProperty(e,r.key,r)}}function n(e,n,i){if(n)t(e.prototype,n);if(i)t(e,i);return e}function i(e,t){return r(e)||o(e,t)||l(e,t)||a()}function r(e){if(Array.isArray(e))return e}function o(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],i=!0,r=!1,o=void 0;try{for(var l=e[Symbol.iterator](),u;!(i=(u=l.next()).done);i=!0){n.push(u.value);if(t&&n.length===t)break}}catch(e){r=!0;o=e}finally{try{if(!i&&null!=l["return"])l["return"]()}finally{if(r)throw o}}return n}function l(e,t){if(!e)return;if("string"==typeof e)return u(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if("Object"===i&&e.constructor)i=e.constructor.name;if("Map"===i||"Set"===i)return Array.from(i);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return u(e,t)}function u(e,t){if(null==t||t>e.length)t=e.length;for(var n=0,r=Array(t);n<t;n++){r[n]=e[n]}return r}function a(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}if(!Array.prototype.find){Array.prototype.find=function(e){if(null===this){throw new TypeError("Array.prototype.find called on null or undefined")}if("function"!=typeof e){throw new TypeError("predicate must be a function")}for(var t=Object(this),n=t.length>>>0,r=arguments[1],o,l=0;l<n;l++){o=t[l];if(e.call(r,o,l,t)){return o}}}}if(window&&"function"!=typeof window.CustomEvent){var c=function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var n=document.createEvent("CustomEvent");n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail);return n};if("undefined"!=typeof window.Event){c.prototype=window.Event.prototype}window.CustomEvent=c}var s=function(){function t(n){e(this,t);this.tribute=n;this.tribute.events=this}n(t,[{key:"bind",value:function(e){e.boundKeydown=this.keydown.bind(e,this);e.boundKeyup=this.keyup.bind(e,this);e.boundInput=this.input.bind(e,this);e.addEventListener("keydown",e.boundKeydown,!1);e.addEventListener("keyup",e.boundKeyup,!1);e.addEventListener("input",e.boundInput,!1)}},{key:"unbind",value:function(e){e.removeEventListener("keydown",e.boundKeydown,!1);e.removeEventListener("keyup",e.boundKeyup,!1);e.removeEventListener("input",e.boundInput,!1);delete e.boundKeydown;delete e.boundKeyup;delete e.boundInput}},{key:"keydown",value:function(e,n){if(e.shouldDeactivate(n)){e.tribute.isActive=!1;e.tribute.hideMenu()}var i=this;e.commandEvent=!1;t.keys().forEach(function(t){if(t.key===n.keyCode){e.commandEvent=!0;e.callbacks()[t.value.toLowerCase()](n,i)}})}},{key:"input",value:function(e,t){e.inputEvent=!0;e.keyup.call(this,e,t)}},{key:"click",value:function(e,t){var n=e.tribute;if(n.menu&&n.menu.contains(t.target)){var i=t.target;t.preventDefault();t.stopPropagation();while("li"!==i.nodeName.toLowerCase()){i=i.parentNode;if(!i||i===n.menu){throw new Error("cannot find the <li> container for the click")}}n.selectItemAtIndex(i.getAttribute("data-index"),t);n.hideMenu()}else if(n.current.element&&!n.current.externalTrigger){n.current.externalTrigger=!1;setTimeout(function(){return n.hideMenu()})}}},{key:"keyup",value:function(e,t){if(e.inputEvent){e.inputEvent=!1}e.updateSelection(this);if(27===t.keyCode)return;if(!e.tribute.allowSpaces&&e.tribute.hasTrailingSpace){e.tribute.hasTrailingSpace=!1;e.commandEvent=!0;e.callbacks().space(t,this);return}if(!e.tribute.isActive){if(e.tribute.autocompleteMode){e.callbacks().triggerChar(t,this,"")}else{var n=e.getKeyCode(e,this,t);if(isNaN(n)||!n)return;var i=e.tribute.triggers().find(function(e){return e.charCodeAt(0)===n});if("undefined"!=typeof i){e.callbacks().triggerChar(t,this,i)}}}if(e.tribute.current.mentionText.length<e.tribute.current.collection.menuShowMinLength){return}if((e.tribute.current.trigger||e.tribute.autocompleteMode)&&!1===e.commandEvent||e.tribute.isActive&&8===t.keyCode){e.tribute.showMenuFor(this,!0)}}},{key:"shouldDeactivate",value:function(e){if(!this.tribute.isActive)return!1;if(0===this.tribute.current.mentionText.length){var n=!1;t.keys().forEach(function(t){if(e.keyCode===t.key)n=!0});return!n}return!1}},{key:"getKeyCode",value:function(e){var t=e.tribute,n=t.range.getTriggerInfo(!1,t.hasTrailingSpace,!0,t.allowSpaces,t.autocompleteMode);if(n){return n.mentionTriggerChar.charCodeAt(0)}else{return!1}}},{key:"updateSelection",value:function(e){this.tribute.current.element=e;var t=this.tribute.range.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(t){this.tribute.current.selectedPath=t.mentionSelectedPath;this.tribute.current.mentionText=t.mentionText;this.tribute.current.selectedOffset=t.mentionSelectedOffset}}},{key:"callbacks",value:function(){var t=this;return{triggerChar:function(n,e,i){var r=t.tribute;r.current.trigger=i;var o=r.collection.find(function(e){return e.trigger===i});r.current.collection=o;if(r.current.mentionText.length>=r.current.collection.menuShowMinLength&&r.inputEvent){r.showMenuFor(e,!0)}},enter:function(n){if(t.tribute.isActive&&t.tribute.current.filteredItems){n.preventDefault();n.stopPropagation();setTimeout(function(){t.tribute.selectItemAtIndex(t.tribute.menuSelected,n);t.tribute.hideMenu()},0)}},escape:function(n){if(t.tribute.isActive){n.preventDefault();n.stopPropagation();t.tribute.isActive=!1;t.tribute.hideMenu()}},tab:function(n,e){t.callbacks().enter(n,e)},space:function(n,e){if(t.tribute.isActive){if(t.tribute.spaceSelectsMatch){t.callbacks().enter(n,e)}else if(!t.tribute.allowSpaces){n.stopPropagation();setTimeout(function(){t.tribute.hideMenu();t.tribute.isActive=!1},0)}}},up:function(n){if(t.tribute.isActive&&t.tribute.current.filteredItems){n.preventDefault();n.stopPropagation();var e=t.tribute.current.filteredItems.length,i=t.tribute.menuSelected;if(e>i&&0<i){t.tribute.menuSelected--;t.setActiveLi()}else if(0===i){t.tribute.menuSelected=e-1;t.setActiveLi();t.tribute.menu.scrollTop=t.tribute.menu.scrollHeight}}},down:function(n){if(t.tribute.isActive&&t.tribute.current.filteredItems){n.preventDefault();n.stopPropagation();var e=t.tribute.current.filteredItems.length-1,i=t.tribute.menuSelected;if(e>i){t.tribute.menuSelected++;t.setActiveLi()}else if(e===i){t.tribute.menuSelected=0;t.setActiveLi();t.tribute.menu.scrollTop=0}}},delete:function(n,e){if(t.tribute.isActive&&1>t.tribute.current.mentionText.length){t.tribute.hideMenu()}else if(t.tribute.isActive){t.tribute.showMenuFor(e)}}}}},{key:"setActiveLi",value:function(e){var t=this.tribute.menu.querySelectorAll("li"),n=t.length>>>0;if(e)this.tribute.menuSelected=parseInt(e);for(var r=0,o;r<n;r++){o=t[r];if(r===this.tribute.menuSelected){o.classList.add(this.tribute.current.collection.selectClass);var l=o.getBoundingClientRect(),u=this.tribute.menu.getBoundingClientRect();if(l.bottom>u.bottom){var a=l.bottom-u.bottom;this.tribute.menu.scrollTop+=a}else if(l.top<u.top){var c=u.top-l.top;this.tribute.menu.scrollTop-=c}}else{o.classList.remove(this.tribute.current.collection.selectClass)}}}},{key:"getFullHeight",value:function(e,t){var n=e.getBoundingClientRect().height;if(t){var i=e.currentStyle||window.getComputedStyle(e);return n+parseFloat(i.marginTop)+parseFloat(i.marginBottom)}return n}}],[{key:"keys",value:function(){return[{key:9,value:"TAB"},{key:8,value:"DELETE"},{key:13,value:"ENTER"},{key:27,value:"ESCAPE"},{key:32,value:"SPACE"},{key:38,value:"UP"},{key:40,value:"DOWN"}]}}]);return t}(),d=function(){function t(n){e(this,t);this.tribute=n;this.tribute.menuEvents=this;this.menu=this.tribute.menu}n(t,[{key:"bind",value:function(){var e=this;this.menuClickEvent=this.tribute.events.click.bind(null,this);this.menuContainerScrollEvent=this.debounce(function(){if(e.tribute.isActive){e.tribute.showMenuFor(e.tribute.current.element,!1)}},300,!1);this.windowResizeEvent=this.debounce(function(){if(e.tribute.isActive){e.tribute.range.positionMenuAtCaret(!0)}},300,!1);this.tribute.range.getDocument().addEventListener("MSPointerDown",this.menuClickEvent,!1);this.tribute.range.getDocument().addEventListener("mousedown",this.menuClickEvent,!1);window.addEventListener("resize",this.windowResizeEvent);if(this.menuContainer){this.menuContainer.addEventListener("scroll",this.menuContainerScrollEvent,!1)}else{window.addEventListener("scroll",this.menuContainerScrollEvent)}}},{key:"unbind",value:function(){this.tribute.range.getDocument().removeEventListener("mousedown",this.menuClickEvent,!1);this.tribute.range.getDocument().removeEventListener("MSPointerDown",this.menuClickEvent,!1);window.removeEventListener("resize",this.windowResizeEvent);if(this.menuContainer){this.menuContainer.removeEventListener("scroll",this.menuContainerScrollEvent,!1)}else{window.removeEventListener("scroll",this.menuContainerScrollEvent)}}},{key:"debounce",value:function(e,t,n){var i=arguments,r=this,o;return function(){var l=r,u=i,a=n&&!o;clearTimeout(o);o=setTimeout(function(){o=null;if(!n)e.apply(l,u)},t);if(a)e.apply(l,u)}}}]);return t}(),m=function(){function t(n){e(this,t);this.tribute=n;this.tribute.range=this}n(t,[{key:"getDocument",value:function(){var e;if(this.tribute.current.collection){e=this.tribute.current.collection.iframe}if(!e){return document}return e.contentWindow.document}},{key:"positionMenuAtCaret",value:function(e){var t=this,n=this.tribute.current,i,r=this.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);if("undefined"!=typeof r){if(!this.tribute.positionMenu){this.tribute.menu.style.cssText="display: block;";return}if(!this.isContentEditable(n.element)){i=this.getTextAreaOrInputUnderlinePosition(this.tribute.current.element,r.mentionPosition)}else{i=this.getContentEditableCaretPosition(r.mentionPosition)}this.tribute.menu.style.cssText="top: ".concat(i.top,"px;\n                                     left: ").concat(i.left,"px;\n                                     right: ").concat(i.right,"px;\n                                     bottom: ").concat(i.bottom,"px;\n                                     position: absolute;\n                                     display: block;");if("auto"===i.left){this.tribute.menu.style.left="auto"}if("auto"===i.top){this.tribute.menu.style.top="auto"}if(e)this.scrollIntoView();window.setTimeout(function(){var n={width:t.tribute.menu.offsetWidth,height:t.tribute.menu.offsetHeight},r=t.isMenuOffScreen(i,n),o=window.innerWidth>n.width&&(r.left||r.right),l=window.innerHeight>n.height&&(r.top||r.bottom);if(o||l){t.tribute.menu.style.cssText="display: none";t.positionMenuAtCaret(e)}},0)}else{this.tribute.menu.style.cssText="display: none"}}},{key:"selectElement",value:function(e,t,n){var r,o=e;if(t){for(var l=0;l<t.length;l++){o=o.childNodes[t[l]];if(o===void 0){return}while(o.length<n){n-=o.length;o=o.nextSibling}if(0===o.childNodes.length&&!o.length){o=o.previousSibling}}}var u=this.getWindowSelection();r=this.getDocument().createRange();r.setStart(o,n);r.setEnd(o,n);r.collapse(!0);try{u.removeAllRanges()}catch(e){}u.addRange(r);e.focus()}},{key:"replaceTriggerText",value:function(e,t,n,i,r){var o=this.getTriggerInfo(!0,n,t,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(o!==void 0){var l=this.tribute.current,u=new CustomEvent("tribute-replaced",{detail:{item:r,instance:l,context:o,event:i}});if(!this.isContentEditable(l.element)){var a=this.tribute.current.element,c="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ";e+=c;var s=o.mentionPosition,d=o.mentionPosition+o.mentionText.length+c.length;if(!this.tribute.autocompleteMode){d+=o.mentionTriggerChar.length-1}a.value=a.value.substring(0,s)+e+a.value.substring(d,a.value.length);a.selectionStart=s+e.length;a.selectionEnd=s+e.length}else{var m="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:"\xA0";e+=m;var g=o.mentionPosition+o.mentionText.length;if(!this.tribute.autocompleteMode){g+=o.mentionTriggerChar.length}this.pasteHtml(e,o.mentionPosition,g)}l.element.dispatchEvent(new CustomEvent("input",{bubbles:!0}));l.element.dispatchEvent(u)}}},{key:"pasteHtml",value:function(e,t,n){var i,r;r=this.getWindowSelection();i=this.getDocument().createRange();i.setStart(r.anchorNode,t);i.setEnd(r.anchorNode,n);i.deleteContents();var o=this.getDocument().createElement("div");o.innerHTML=e;var l=this.getDocument().createDocumentFragment(),u,a;while(u=o.firstChild){a=l.appendChild(u)}i.insertNode(l);if(a){i=i.cloneRange();i.setStartAfter(a);i.collapse(!0);r.removeAllRanges();r.addRange(i)}}},{key:"getWindowSelection",value:function(){if(this.tribute.collection.iframe){return this.tribute.collection.iframe.contentWindow.getSelection()}return window.getSelection()}},{key:"getNodePositionInParent",value:function(e){if(null===e.parentNode){return 0}for(var t=0,n;t<e.parentNode.childNodes.length;t++){n=e.parentNode.childNodes[t];if(n===e){return t}}}},{key:"getContentEditableSelectedPath",value:function(){var e=this.getWindowSelection(),t=e.anchorNode,n=[],r;if(null!=t){var o,l=t.contentEditable;while(null!==t&&"true"!==l){o=this.getNodePositionInParent(t);n.push(o);t=t.parentNode;if(null!==t){l=t.contentEditable}}n.reverse();r=e.getRangeAt(0).startOffset;return{selected:t,path:n,offset:r}}}},{key:"getTextPrecedingCurrentSelection",value:function(){var e=this.tribute.current,t="";if(!this.isContentEditable(e.element)){var n=this.tribute.current.element;if(n){var i=n.selectionStart;if(n.value&&0<=i){t=n.value.substring(0,i)}}}else{var r=this.getWindowSelection().anchorNode;if(null!=r){var o=r.textContent,l=this.getWindowSelection().getRangeAt(0).startOffset;if(o&&0<=l){t=o.substring(0,l)}}}return t}},{key:"getLastWordInText",value:function(e){e=e.replace(/\u00A0/g," ");var t;if(this.tribute.autocompleteSeparator){t=e.split(this.tribute.autocompleteSeparator)}else{t=e.split(/\s+/)}var n=t.length-1;return t[n].trim()}},{key:"getTriggerInfo",value:function(e,t,n,i,r){var o=this,l=this.tribute.current,u,a,c;if(!this.isContentEditable(l.element)){u=this.tribute.current.element}else{var s=this.getContentEditableSelectedPath(l);if(s){u=s.selected;a=s.path;c=s.offset}}var d=this.getTextPrecedingCurrentSelection(),m=this.getLastWordInText(d);if(r){return{mentionPosition:d.length-m.length,mentionText:m,mentionSelectedElement:u,mentionSelectedPath:a,mentionSelectedOffset:c}}if(d!==void 0&&null!==d){var g=-1,p;this.tribute.collection.forEach(function(e){var t=e.trigger,i=e.requireLeadingSpace?o.lastIndexWithLeadingSpace(d,t):d.lastIndexOf(t);if(i>g){g=i;p=t;n=e.requireLeadingSpace}});if(0<=g&&(0===g||!n||/[\xA0\s]/g.test(d.substring(g-1,g)))){var b=d.substring(g+p.length,d.length);p=d.substring(g,g+p.length);var h=b.substring(0,1),f=0<b.length&&(" "===h||"\xA0"===h);if(t){b=b.trim()}var v=i?/[^\S ]/g:/[\xA0\s]/g;this.tribute.hasTrailingSpace=v.test(b);if(!f&&(e||!v.test(b))){return{mentionPosition:g,mentionText:b,mentionSelectedElement:u,mentionSelectedPath:a,mentionSelectedOffset:c,mentionTriggerChar:p}}}}}},{key:"lastIndexWithLeadingSpace",value:function(e,t){for(var n=e.split("").reverse().join(""),i=-1,r=0,o=e.length;r<o;r++){for(var l=r==e.length-1,u=/\s/.test(n[r+1]),a=!0,c=t.length-1;0<=c;c--){if(t[c]!==n[r-c]){a=!1;break}}if(a&&(l||u)){i=e.length-1-r;break}}return i}},{key:"isContentEditable",value:function(e){return"INPUT"!==e.nodeName&&"TEXTAREA"!==e.nodeName}},{key:"isMenuOffScreen",value:function(e,t){var n=window.innerWidth,i=window.innerHeight,r=document.documentElement,o=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),l=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),u="number"==typeof e.top?e.top:l+i-e.bottom-t.height,a="number"==typeof e.right?e.right:e.left+t.width,c="number"==typeof e.bottom?e.bottom:e.top+t.height,s="number"==typeof e.left?e.left:o+n-e.right-t.width;return{top:u<Math.floor(l),right:a>Math.ceil(o+n),bottom:c>Math.ceil(l+i),left:s<Math.floor(o)}}},{key:"getMenuDimensions",value:function(){var e={width:null,height:null};this.tribute.menu.style.cssText="top: 0px;\n                                 left: 0px;\n                                 position: fixed;\n                                 display: block;\n                                 visibility; hidden;";e.width=this.tribute.menu.offsetWidth;e.height=this.tribute.menu.offsetHeight;this.tribute.menu.style.cssText="display: none;";return e}},{key:"getTextAreaOrInputUnderlinePosition",value:function(e,t){var n=null!==window.mozInnerScreenX,i=this.getDocument().createElement("div");i.id="input-textarea-caret-position-mirror-div";this.getDocument().body.appendChild(i);var r=i.style,o=window.getComputedStyle?getComputedStyle(e):e.currentStyle;r.whiteSpace="pre-wrap";if("INPUT"!==e.nodeName){r.wordWrap="break-word"}r.position="absolute";r.visibility="hidden";["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"].forEach(function(e){r[e]=o[e]});if(n){r.width="".concat(parseInt(o.width)-2,"px");if(e.scrollHeight>parseInt(o.height))r.overflowY="scroll"}else{r.overflow="hidden"}i.textContent=e.value.substring(0,t);if("INPUT"===e.nodeName){i.textContent=i.textContent.replace(/\s/g," ")}var l=this.getDocument().createElement("span");l.textContent=e.value.substring(t)||".";i.appendChild(l);var u=e.getBoundingClientRect(),a=document.documentElement,c=(window.pageXOffset||a.scrollLeft)-(a.clientLeft||0),s=(window.pageYOffset||a.scrollTop)-(a.clientTop||0),d=0,m=0;if(this.menuContainerIsBody){d=u.top;m=u.left}var g={top:d+s+l.offsetTop+parseInt(o.borderTopWidth)+parseInt(o.fontSize)-e.scrollTop,left:m+c+l.offsetLeft+parseInt(o.borderLeftWidth)},p=window.innerWidth,b=window.innerHeight,h=this.getMenuDimensions(),f=this.isMenuOffScreen(g,h);if(f.right){g.right=p-g.left;g.left="auto"}var v=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;if(f.bottom){var y=this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect(),T=v-(b-y.top);g.bottom=T+(b-u.top-l.offsetTop);g.top="auto"}f=this.isMenuOffScreen(g,h);if(f.left){g.left=p>h.width?c+p-h.width:c;delete g.right}if(f.top){g.top=b>h.height?s+b-h.height:s;delete g.bottom}this.getDocument().body.removeChild(i);return g}},{key:"getContentEditableCaretPosition",value:function(e){var t,n=this.getWindowSelection();t=this.getDocument().createRange();t.setStart(n.anchorNode,e);t.setEnd(n.anchorNode,e);t.collapse(!1);var i=t.getBoundingClientRect(),r=document.documentElement,o=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),l=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),u=i.left,a=i.top,c={left:u+o,top:a+i.height+l},s=window.innerWidth,d=window.innerHeight,m=this.getMenuDimensions(),g=this.isMenuOffScreen(c,m);if(g.right){c.left="auto";c.right=s-i.left-o}var p=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;if(g.bottom){var b=this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect(),h=p-(d-b.top);c.top="auto";c.bottom=h+(d-i.top)}g=this.isMenuOffScreen(c,m);if(g.left){c.left=s>m.width?o+s-m.width:o;delete c.right}if(g.top){c.top=d>m.height?l+d-m.height:l;delete c.bottom}if(!this.menuContainerIsBody){c.left=c.left?c.left-this.tribute.menuContainer.offsetLeft:c.left;c.top=c.top?c.top-this.tribute.menuContainer.offsetTop:c.top}return c}},{key:"scrollIntoView",value:function(){var t,n=100,i=this.menu;if("undefined"==typeof i)return;while(t===void 0||0===t.height){t=i.getBoundingClientRect();if(0===t.height){i=i.childNodes[0];if(i===void 0||!i.getBoundingClientRect){return}}}var r=t.top,o=r+t.height;if(0>r){window.scrollTo(0,window.pageYOffset+t.top-20)}else if(o>window.innerHeight){var l=window.pageYOffset+t.top-20;if(l-window.pageYOffset>n){l=window.pageYOffset+n}var u=window.pageYOffset-(window.innerHeight-o);if(u>l){u=l}window.scrollTo(0,u)}}},{key:"menuContainerIsBody",get:function(){return this.tribute.menuContainer===document.body||!this.tribute.menuContainer}}]);return t}(),g=function(){function t(n){e(this,t);this.tribute=n;this.tribute.search=this}n(t,[{key:"simpleFilter",value:function(e,t){var n=this;return t.filter(function(t){return n.test(e,t)})}},{key:"test",value:function(e,t){return null!==this.match(e,t)}},{key:"match",value:function(e,t,n){n=n||{};var i=t.length,r=n.pre||"",o=n.post||"",l=n.caseSensitive&&t||t.toLowerCase();if(n.skip){return{rendered:t,score:0}}e=n.caseSensitive&&e||e.toLowerCase();var u=this.traverse(l,e,0,0,[]);if(!u){return null}return{rendered:this.render(t,u.cache,r,o),score:u.score}}},{key:"traverse",value:function(e,t,n,i,r){if(this.tribute.autocompleteSeparator){t=t.split(this.tribute.autocompleteSeparator).splice(-1)[0]}if(t.length===i){return{score:this.calculateScore(r),cache:r.slice()}}if(e.length===n||t.length-i>e.length-n){return}var o=t[i],l=e.indexOf(o,n),u,a;while(-1<l){r.push(l);a=this.traverse(e,t,l+1,i+1,r);r.pop();if(!a){return u}if(!u||u.score<a.score){u=a}l=e.indexOf(o,l+1)}return u}},{key:"calculateScore",value:function(e){var t=0,n=1;e.forEach(function(r,o){if(0<o){if(e[o-1]+1===r){n+=n+1}else{n=1}}t+=n});return t}},{key:"render",value:function(e,t,n,r){var o=e.substring(0,t[0]);t.forEach(function(l,u){o+=n+e[l]+r+e.substring(l+1,t[u+1]?t[u+1]:e.length)});return o}},{key:"filter",value:function(e,t,n){var i=this;n=n||{};return t.reduce(function(t,r,o){var l=r;if(n.extract){l=n.extract(r);if(!l){l=""}}var u=i.match(e,l,n);if(null!=u){t[t.length]={string:u.rendered,score:u.score,index:o,original:r}}return t},[]).sort(function(e,t){var n=t.score-e.score;if(n)return n;return e.index-t.index})}}]);return t}(),p=function(){function t(n){var i=this,r=n.values,o=void 0===r?null:r,l=n.loadingItemTemplate,u=void 0===l?null:l,a=n.iframe,c=void 0===a?null:a,p=n.selectClass,b=void 0===p?"highlight":p,h=n.containerClass,f=void 0===h?"tribute-container":h,v=n.itemClass,y=void 0===v?"":v,T=n.trigger,C=void 0===T?"@":T,S=n.autocompleteMode,k=void 0===S?!1:S,E=n.autocompleteSeparator,x=void 0===E?null:E,M=n.selectTemplate,w=void 0===M?null:M,A=n.menuItemTemplate,L=void 0===A?null:A,I=n.lookup,N=void 0===I?"key":I,D=n.fillAttr,P=void 0===D?"value":D,O=n.collection,R=void 0===O?null:O,W=n.menuContainer,H=void 0===W?null:W,B=n.noMatchTemplate,_=void 0===B?null:B,F=n.requireLeadingSpace,Y=void 0===F?!0:F,z=n.allowSpaces,K=void 0===z?!1:z,q=n.replaceTextSuffix,U=void 0===q?null:q,X=n.positionMenu,j=void 0===X?!0:X,V=n.spaceSelectsMatch,G=void 0===V?!1:V,J=n.searchOpts,Q=void 0===J?{}:J,Z=n.menuItemLimit,$=void 0===Z?null:Z,ee=n.menuShowMinLength,te=void 0===ee?0:ee;e(this,t);this.autocompleteMode=k;this.autocompleteSeparator=x;this.menuSelected=0;this.current={};this.inputEvent=!1;this.isActive=!1;this.menuContainer=H;this.allowSpaces=K;this.replaceTextSuffix=U;this.positionMenu=j;this.hasTrailingSpace=!1;this.spaceSelectsMatch=G;if(this.autocompleteMode){C="";K=!1}if(o){this.collection=[{trigger:C,iframe:c,selectClass:b,containerClass:f,itemClass:y,selectTemplate:(w||t.defaultSelectTemplate).bind(this),menuItemTemplate:(L||t.defaultMenuItemTemplate).bind(this),noMatchTemplate:function(e){if("string"==typeof e){if(""===e.trim())return null;return e}if("function"==typeof e){return e.bind(i)}return _||function(){return"<li>No Match Found!</li>"}.bind(i)}(_),lookup:N,fillAttr:P,values:o,loadingItemTemplate:u,requireLeadingSpace:Y,searchOpts:Q,menuItemLimit:$,menuShowMinLength:te}]}else if(R){if(this.autocompleteMode)console.warn("Tribute in autocomplete mode does not work for collections");this.collection=R.map(function(e){return{trigger:e.trigger||C,iframe:e.iframe||c,selectClass:e.selectClass||b,containerClass:e.containerClass||f,itemClass:e.itemClass||y,selectTemplate:(e.selectTemplate||t.defaultSelectTemplate).bind(i),menuItemTemplate:(e.menuItemTemplate||t.defaultMenuItemTemplate).bind(i),noMatchTemplate:function(e){if("string"==typeof e){if(""===e.trim())return null;return e}if("function"==typeof e){return e.bind(i)}return _||function(){return"<li>No Match Found!</li>"}.bind(i)}(_),lookup:e.lookup||N,fillAttr:e.fillAttr||P,values:e.values,loadingItemTemplate:e.loadingItemTemplate,requireLeadingSpace:e.requireLeadingSpace,searchOpts:e.searchOpts||Q,menuItemLimit:e.menuItemLimit||$,menuShowMinLength:e.menuShowMinLength||te}})}else{throw new Error("[Tribute] No collection specified.")}new m(this);new s(this);new d(this);new g(this)}n(t,[{key:"triggers",value:function(){return this.collection.map(function(e){return e.trigger})}},{key:"attach",value:function(e){if(!e){throw new Error("[Tribute] Must pass in a DOM node or NodeList.")}if("undefined"!=typeof jQuery&&e instanceof jQuery){e=e.get()}if(e.constructor===NodeList||e.constructor===HTMLCollection||e.constructor===Array){for(var t=e.length,n=0;n<t;++n){this._attach(e[n])}}else{this._attach(e)}}},{key:"_attach",value:function(e){if(e.hasAttribute("data-tribute")){console.warn("Tribute was already bound to "+e.nodeName)}this.ensureEditable(e);this.events.bind(e);e.setAttribute("data-tribute",!0)}},{key:"ensureEditable",value:function(e){if(-1===t.inputTypes().indexOf(e.nodeName)){if(e.contentEditable){e.contentEditable=!0}else{throw new Error("[Tribute] Cannot bind to "+e.nodeName)}}}},{key:"createMenu",value:function(e){var t=this.range.getDocument().createElement("div"),n=this.range.getDocument().createElement("ul");t.className=e;t.appendChild(n);if(this.menuContainer){return this.menuContainer.appendChild(t)}return this.range.getDocument().body.appendChild(t)}},{key:"showMenuFor",value:function(e,t){var n=this;if(this.isActive&&this.current.element===e&&this.current.mentionText===this.currentMentionTextSnapshot){return}this.currentMentionTextSnapshot=this.current.mentionText;if(!this.menu){this.menu=this.createMenu(this.current.collection.containerClass);e.tributeMenu=this.menu;this.menuEvents.bind(this.menu)}this.isActive=!0;this.menuSelected=0;if(!this.current.mentionText){this.current.mentionText=""}var r=function(e){if(!n.isActive){return}var r=n.search.filter(n.current.mentionText,e,{pre:n.current.collection.searchOpts.pre||"<span>",post:n.current.collection.searchOpts.post||"</span>",skip:n.current.collection.searchOpts.skip,extract:function(e){if("string"==typeof n.current.collection.lookup){return e[n.current.collection.lookup]}else if("function"==typeof n.current.collection.lookup){return n.current.collection.lookup(e,n.current.mentionText)}else{throw new Error("Invalid lookup attribute, lookup must be string or function.")}}});if(n.current.collection.menuItemLimit){r=r.slice(0,n.current.collection.menuItemLimit)}n.current.filteredItems=r;var o=n.menu.querySelector("ul");n.range.positionMenuAtCaret(t);if(!r.length){var l=new CustomEvent("tribute-no-match",{detail:n.menu});n.current.element.dispatchEvent(l);if("function"==typeof n.current.collection.noMatchTemplate&&!n.current.collection.noMatchTemplate()||!n.current.collection.noMatchTemplate){n.hideMenu()}else{"function"==typeof n.current.collection.noMatchTemplate?o.innerHTML=n.current.collection.noMatchTemplate():o.innerHTML=n.current.collection.noMatchTemplate}return}o.innerHTML="";var u=n.range.getDocument().createDocumentFragment();r.forEach(function(e,t){var r=n.range.getDocument().createElement("li");r.setAttribute("data-index",t);r.className=n.current.collection.itemClass;r.addEventListener("mousemove",function(t){var e=n._findLiTarget(t.target),r=i(e,2),o=r[0],l=r[1];if(0!==t.movementY){n.events.setActiveLi(l)}});if(n.menuSelected===t){r.classList.add(n.current.collection.selectClass)}r.innerHTML=n.current.collection.menuItemTemplate(e);u.appendChild(r)});o.appendChild(u)};if("function"==typeof this.current.collection.values){if(this.current.collection.loadingItemTemplate){this.menu.querySelector("ul").innerHTML=this.current.collection.loadingItemTemplate;this.range.positionMenuAtCaret(t)}this.current.collection.values(this.current.mentionText,r)}else{r(this.current.collection.values)}}},{key:"_findLiTarget",value:function(e){if(!e)return[];var t=e.getAttribute("data-index");return!t?this._findLiTarget(e.parentNode):[e,t]}},{key:"showMenuForCollection",value:function(e,t){if(e!==document.activeElement){this.placeCaretAtEnd(e)}this.current.collection=this.collection[t||0];this.current.externalTrigger=!0;this.current.element=e;if(e.isContentEditable)this.insertTextAtCursor(this.current.collection.trigger);else this.insertAtCaret(e,this.current.collection.trigger);this.showMenuFor(e)}},{key:"placeCaretAtEnd",value:function(e){e.focus();if("undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var t=document.createRange();t.selectNodeContents(e);t.collapse(!1);var n=window.getSelection();n.removeAllRanges();n.addRange(t)}else if("undefined"!=typeof document.body.createTextRange){var i=document.body.createTextRange();i.moveToElementText(e);i.collapse(!1);i.select()}}},{key:"insertTextAtCursor",value:function(e){var t,n;t=window.getSelection();n=t.getRangeAt(0);n.deleteContents();var i=document.createTextNode(e);n.insertNode(i);n.selectNodeContents(i);n.collapse(!1);t.removeAllRanges();t.addRange(n)}},{key:"insertAtCaret",value:function(e,t){var n=e.scrollTop,i=e.selectionStart,r=e.value.substring(0,i),o=e.value.substring(e.selectionEnd,e.value.length);e.value=r+t+o;i=i+t.length;e.selectionStart=i;e.selectionEnd=i;e.focus();e.scrollTop=n}},{key:"hideMenu",value:function(){if(this.menu){this.menu.style.cssText="display: none;";this.isActive=!1;this.menuSelected=0;this.current={}}}},{key:"selectItemAtIndex",value:function(e,t){e=parseInt(e);if("number"!=typeof e||isNaN(e))return;var n=this.current.filteredItems[e],i=this.current.collection.selectTemplate(n);if(null!==i)this.replaceText(i,t,n)}},{key:"replaceText",value:function(e,t,n){this.range.replaceTriggerText(e,!0,!0,t,n)}},{key:"_append",value:function(e,t,n){if("function"==typeof e.values){throw new Error("Unable to append to values, as it is a function.")}else if(!n){e.values=e.values.concat(t)}else{e.values=t}}},{key:"append",value:function(e,t,n){var i=parseInt(e);if("number"!=typeof i)throw new Error("please provide an index for the collection to update.");var r=this.collection[i];this._append(r,t,n)}},{key:"appendCurrent",value:function(e,t){if(this.isActive){this._append(this.current.collection,e,t)}else{throw new Error("No active state. Please use append instead and pass an index.")}}},{key:"detach",value:function(e){if(!e){throw new Error("[Tribute] Must pass in a DOM node or NodeList.")}if("undefined"!=typeof jQuery&&e instanceof jQuery){e=e.get()}if(e.constructor===NodeList||e.constructor===HTMLCollection||e.constructor===Array){for(var t=e.length,n=0;n<t;++n){this._detach(e[n])}}else{this._detach(e)}}},{key:"_detach",value:function(e){var t=this;this.events.unbind(e);if(e.tributeMenu){this.menuEvents.unbind(e.tributeMenu)}setTimeout(function(){e.removeAttribute("data-tribute");t.isActive=!1;if(e.tributeMenu){e.tributeMenu.remove()}})}},{key:"isActive",get:function(){return this._isActive},set:function(e){if(this._isActive!=e){this._isActive=e;if(this.current.element){var t=new CustomEvent("tribute-active-".concat(e));this.current.element.dispatchEvent(t)}}}}],[{key:"defaultSelectTemplate",value:function(e){if("undefined"==typeof e)return"".concat(this.current.collection.trigger).concat(this.current.mentionText);if(this.range.isContentEditable(this.current.element)){return"<span class=\"tribute-mention\">"+(this.current.collection.trigger+e.original[this.current.collection.fillAttr])+"</span>"}return this.current.collection.trigger+e.original[this.current.collection.fillAttr]}},{key:"defaultMenuItemTemplate",value:function(e){return e.string}},{key:"inputTypes",value:function(){return["TEXTAREA","INPUT"]}}]);return t}();return p});
//# sourceMappingURL=tribute.min.js.map
